language: php

php:
  - 5.6

sudo: false

services:
  - mysql

env:
  global:
    - PLUGIN_NAME=TestPlugin
    - PLUGIN_DIRECTORY=$HOME/shopware/custom/plugins

cache:
   directories:
     - $HOME/.composer/cache/files

before_install:
  - phpenv config-rm xdebug.ini

install:
  - git clone https://github.com/shopware/shopware.git $HOME/shopware
  - ant -f $HOME/shopware/build/build.xml -Dapp.host=localhost -Ddb.user=travis -Ddb.host=127.0.0.1 -Ddb.name=shopware build-unit
  - mv $TRAVIS_BUILD_DIR $PLUGIN_DIRECTORY/$PLUGIN_NAME
  - cd $PLUGIN_DIRECTORY/$PLUGIN_NAME
  - composer install
  - php $HOME/shopware/bin/console sw:plugin:refresh
  - php $HOME/shopware/bin/console sw:plugin:install $PLUGIN_NAME
  - php $HOME/shopware/bin/console sw:plugin:activate $PLUGIN_NAME

before_script:
  - cd $PLUGIN_DIRECTORY/$PLUGIN_NAME

script:
  - composer test

matrix:
  allow_failures:
    - php: nightly
